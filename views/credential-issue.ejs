<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Issue Credential</title>
  </head>
  <body>
    <h1>Issue Credential</h1>
    <div>
      <label for="connections">Select a Connection:</label>
      <form id="issueForm" method="post" name="form" id="form" action="/issue-credential-from-ejs-form">
        <select name="connectionId" id="connections">
          <% connections.forEach(connection => { %>
            <option value="<%= connection %>"><%= connection %></option>
          <% }); %>
        </select>
        <div>
          <label for="fullName">Full Name:</label>
          <input type="text" name="fullName" id="fullName" required />
        </div>
        <div>
          <label for="address">Address:</label>
          <input type="text" name="address" id="address" required />
        </div>
        <div>
          <label for="dateOfBirth">Date of Birth:</label>
          <input type="text" name="dateOfBirth" id="dateOfBirth" required />
        </div>
        <div>
          <label for="contactInfo">Contact Info:</label>
          <input type="text" name="contactInfo" id="contactInfo" required />
        </div>
        <button type="submit">Issue Credential</button>
      </form>
    </div>
  </body>
  <script>
    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      try {
        // Get attribute values from the input fields
        const fullName = document.getElementById("fullName").value;
        const address = document.getElementById("address").value;
        const dateOfBirth = document.getElementById("dateOfBirth").value;
        const contactInfo = document.getElementById("contactInfo").value;

        // Generate a random government ID
        const governmentID = generateRandomString();

        // Perform an AJAX request to issue the credential
        const response = await fetch("/issue-credential-from-ejs-form", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            connectionId: form.connectionId.value,
            fullName,
            address,
            dateOfBirth,
            governmentID,
            contactInfo,
          }),
        });

        // Handle the response as needed
        if (response.ok) {
          // Credential issued successfully, redirect or show a success message
        } else {
          // Handle errors, show error message to the user
        }
      } catch (error) {
        console.error("Error issuing credential:", error);
      }
    });

    // Generate a random string of the specified length
    function generateRandomString(length = 20) {
      const characters =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()-_+=<>?";
      let result = "";
      for (let i = 0; i < length; i++) {
        result += characters.charAt(
          Math.floor(Math.random() * characters.length)
        );
      }
      return result;
    }
  </script>
</html>
